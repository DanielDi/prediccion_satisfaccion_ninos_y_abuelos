---
title: ''
author: ''
date: ''
output:
  pdf_document: default
  html_document:
    df_print: paged
lang: es
---
\begin{titlepage}
\centering
{\scshape\Huge Informe Técnico \par}
{\scshape\Huge  Satisfacción de Niños y Abuelos \par}
\vspace{2cm}
{\Large Por: \par}
{\Large Daniel Espinal Mosquera\par}
{\Large Juan Sebastián Falcón\par}
{\Large Juan F. Peña Tamayo\par}
{\Large Brayan M. Ortiz Fajardo\par}
{\Large Thalea Marina Hesse\par}
\vfill
\vspace{0.5cm}

```{r echo=FALSE, out.width = "300px", out.height="150px",fig.align='center'}
knitr::include_graphics("Imagenes/LOGO.png")

```
\vfill
\vspace{0.5cm}
{\bfseries\LARGE Universidad Nacional de Colombia \par Sede Medellín \par}
\vspace{1cm}
\end{titlepage}

```{r setup, include=FALSE, echo=FALSE}
library(caret)
library(party)
library(ggplot2)
library(dplyr)
library(hrbrthemes)
library(readxl)
library(dplyr)
require(ggplot2)
require(corrplot)
library(reshape2)
require(kableExtra)
require(ggcorrplot)
require(magrittr)
library(naniar)
library(polycor)

knitr::opts_chunk$set(echo = TRUE)
```

# Introducción 

La satisfacción de la vida y la felicidad varía entre países \cite{b7} y juegan un papel importante en el desarrollo de un país. Sin embargo, no se logró determinar documentación o estudios relacionados sobre cómo se pueden predecir estos factores en Colombia dados unos parámetros. Por tal motivo, se propone el plantemiento, desarrollo, análisis y posterior productización de un modelo con el cual se busca predecir la satisfacción de niños y abuelos. Para lograr esto, se toma como base una encuesta realizada por el DANE en el 2020: Colombia - Encuesta Nacional de Calidad de Vida - ECV 2020. Esta investigación, según el DANE "Busca cuantificar y caracterizar las condiciones socioeconómicas de los hogares colombianos, con el fin de obtener la información necesaria para la actualización de indicadores sociales a nivel de viviendas, hogares y personas, y para la definición de políticas que permitan diseñar y ejecutar planes sociales." (Metodologia ECV, 2009, p.17)   
La estructura del estudio se planteó de la siguiente manera: se hizo una búsqueda exhaustiva sobre documentación para determinar cuáles de las variables que se tienen afectan de manera significativa la satisfacción. Después se planteó un modelo general, sin embargo al revisar las correlaciones entre las variables predictoras se dicidió partir ese modelo general en tres sub-modelos: satisfacción de salud, seguridad y trabajo. Para cada cada uno de estos también se realizó la búsqueda de documentación al respecto. Adicionalmente, se creó una página web para poder interactuar con los modelos. Finalmente, se obtuvieron los resultados y plantearon las conclusiones. 

# Planteamiento del Problema 

El Instituto Colombiano de Bienestar Familiar es una entidad que trabaja por la prevención y protección integral de la primera infancia, la niñez, la adolescencia y el bienestar general de las familias en Colombia, llegando a millones de colombianos mediante sus programas, estrategias y servicios de atención.  En el marco de los objetivos de esta institución se encontró que el ICBF actualmente no cuenta con una herramienta para conocer en prospectiva, y de forma adecuada y efectiva la satisfacción general de vida tanto de niños como de adultos en la tercera edad. Es para ellos de vital importancia conocer esta información pues es un indicador fundamental a tener en cuenta a la hora de crear programas preventivos y de protección que tienen como objetivo el mejoramiento de vida de la población destinataria. Por esto se busca implementar en el ICBF tanto los 3 sub-modelos como el modelo de satisfacción general, para que sea usado por la institución en pro de mejorar futuros planeamientos en todo proyecto social que involucre niños y adultos de la tercera edad como población objetivo.    




# Justificación 
## Niños

En primera instancia se planteó tomar a los niños en dos grupos, uno como aquellos pertenecientes a la primera infancia (0 a 5 años) y otro con aquellos niños con edad entre 6 y 12 años. Sin embargo, luego se decidio que tomariamos como niño la definicion integrada en el codigo de infancia y adolesencia, donde se expone que "Para todos los efectos de esta ley son sujetos titulares de derechos todas las personas menores de 18 años. Sin perjuicio de lo establecido en el artículo 34 del Código Civil, se entiende por niño o niña las personas entre los 0 y los 12 años, y por adolescente las personas entre 12 y 18 años de edad"(Articulo 3).

Una vez adoptada esta definicion se analizo cuantas observaciones de la ECV cumplian esta condicion, resultando en un total de 56128 niños.


## Abuelos

Para los abuelos, al igual que con los niños, se penso inicialmente en tomar un rango de edad que tomara la definicion popular de este colectivo, los adultos de la tercera edad (mayores de 60 años). Sin embargo, luego planteamos que debiamos tener en cuenta cual es la definicion literal de abuelo,  y mediante un sistema de grafos logramos determinar el numero de hombres y mujeres que tenian un nieto. Filtrandolos por su rango edad.

\begin{table}[H]
\begin{center}
\begin{tabular}{|l|l|}
\hline
Mayor a 60 años & 1467 \\ \hline
Menor a 60 años & 1049 \\ \hline
\end{tabular}
\end{center}
\end{table}

Se observa que con la definicion inicial estabamos omitiendo un total de 1049 observaciones, ademas, se observa que los abuelos resgitrados en la base de datos son relativamente pocos pues solo representan el x% del total de personas.

Ante esta situación tomamos la desicion de ...

# Seleccion de Variables

Para predecir la satisfacción se tomaron en cuenta las evidencias halladas en la bibliografía, donde se encontró que las variables relacionadas con el nivel de satisfacción de una persona son las siguientes:

* NIVEL_DE_EDUCACION
* SEXO
* SALUD_AUTOPERCIBIDA
* ESTADO_CIVIL
* ETNIA
* INGRESO_AUTOPERCIBIDO
* SEGURIDAD_AUTOPERCIBIDA
* TRABAJO_AUTOPERCIBIDO
* SATISFACCION
* I_HOGAR
* PERCAPITA
* COND_VIDA_DEL_HOGAR



```{r lectura_datos, echo=F}
personas <- read.csv2("Datos/personas.csv", header=TRUE, dec=".", encoding="UTF-8")
salud <- read.csv2("Datos/salud.csv", header=TRUE, dec=".", encoding="UTF-8")
educacion <- read.csv2("Datos/educacion.csv", header=TRUE, dec=".", encoding="UTF-8")
cond_hogar <- read.csv2("Datos/condiciones_hogar.csv", header=TRUE, dec=".", encoding="UTF-8")
datos_vivienda <- read.csv2("Datos/datos_vivienda.csv", header=TRUE, dec=".", encoding="UTF-8")
serv_hogar <- read.csv2("Datos/servicios_hogar.csv", header=TRUE, dec=".", encoding="UTF-8")
fuerza_trabajo <- read.csv2("Datos/fuerza_trabajo.csv", header=TRUE, dec=".", encoding="UTF-8")
comp_hogar <- read.csv2("Datos/caracteristicas_composicion_del_hogar.csv", header=TRUE, dec=".", encoding="UTF-8")
```
El primer paso para verificar si las variables anteriores servirán para ajustar algún modelo es hacer un análisis descriptivo de cada una agrupando los niños y abuelos.

# Modelos Predictivos
Inicialmente, se intentó englobar en un modelo a los abuelos y niños con el fin de predecir la satisfacción. Sin embargo, como lo ilustra la tabla 1, las variables objetivos que se seleccionaron no fueron respondidas, en su mayoría, por niños. Este comportamiento se asemeja con los resultados encontrados en \cite{b7}, donde se puede observar que los abuelos y niños tienen diferentes definiciones de satisfacción y, por ende, diferentes factores que la influyen. Por esta razón, se decidió trabajar de forma independiente los modelos para los niños y abuelos.


## Modelos Predictivos en Abuelos
```{r, echo = FALSE}
library(caret)
df_abuelos <- subset(personas, personas$Clasificación != "niño")
```
### Satisfacción de la Vida en General

#### Análisis Descriptivo

##### Conteo de respuestas

```{r,echo=F}
countedAnswers <- aggregate(. ~ Clasificación, personas, FUN = function(x) sum(!is.na(x)), na.action = NULL)
kable(countedAnswers[,1:8]) %>% 
  kable_styling(position = "center")%>%
  kable_styling(latex_options = "HOLD_position") %>% 
  kable_styling(latex_options="scale_down")
kable(countedAnswers[,9:15]) %>% 
  kable_styling(position = "center")%>%
  kable_styling(latex_options = "HOLD_position") %>% 
  kable_styling(latex_options="scale_down")
```

Según la tabla anterior las variables que preguntan directamente por la satisfacción no son respondidas por los niños, por lo tanto se decide abordar y desarrollar modelos por separado para niños y abuelos.

```{r, echo = FALSE}

# Se descartan las columnas que no hacen parte de la predicción
datos <- subset(personas, select = c(SATISFACCION, SALUD_AUTOPERCIBIDA, SEGURIDAD_AUTOPERCIBIDA, 
                                     NIVEL_DE_EDUCACION, COND_VIDA_DEL_HOGAR, TRABAJO_AUTOPERCIBIDO))


# Por facilidad, se renombran las variables a Xi, 1 <= i <= 11
names(datos) <- c('Y', 'X1','X2', 'X3', 'X4', 'X5')
datos <- na.omit(datos)
```

##### Matriz de Correlaciones

Para empezar la selección de posibles variables objetivo y predictoras de las escogidas anteriormente se desarrolla el siguiente gráfico de correlación:

```{r correlación_satisfacción ,echo=F}
varsGeneral <- personas %>% select(-ID_Persona,-Clasificación,-SEXO) %>% na.omit() 
M = cor(varsGeneral)
ggcorrplot(M, hc.order = TRUE, type = "lower",
   lab = TRUE,tl.cex = 8, pch.col = "red",lab_size = 2)
```
Se evalúa la posibilidad de establecer como posible variable objetivo la satisfacción, esta tiene una buena correlación con las variables de satisfacción pero no con el resto, por lo tanto es posible que no tenga mucho sentido predecir la satisfacción general de un abuelo a partir de todas estas variables. Con base en lo anterior se evalúa la implementación de varios modelos, uno por cada variable de satisfacción.

#### KNN

```{r, echo = FALSE}
# Normalización de los datos
set.seed(27042022) # se fija por reproducibilidad

Y <- datos$Y
X_centrada <- scale(datos,center = TRUE, scale = TRUE)
media_total <- attr(X_centrada,'scaled:center')
desv_est_total <- attr(X_centrada,'scaled:scale')
```

```{r, echo = FALSE}
set.seed(27042022) # se fija por reproducibilidad

# Separación de los datos en entrenamiento y prueba
datos1 <- sample(2, nrow(datos),
                   replace = T,
                    prob = c(0.75, 0.25))

train <- datos[datos1 == 1,]
test <- datos[datos1 == 2,]

# Modelo de KNN con 4-folds
modelo_knn_k4 <- knnreg(x=X_centrada,y=Y,k=4)

test$KNN_Predict <- predict(modelo_knn_k4, newdata = test)
head(test[ , c('Y', 'KNN_Predict')])
```

#### Regresion con lm y glm
```{r, echo=FALSE}
set.seed(27042022) # se fija por reproducibilidad


# Separación de los datos en entrenamiento y prueba
datos1 <- sample(2, nrow(datos),
                   replace = T,
                   prob = c(0.75, 0.25))

train <- datos[datos1 == 1,]
test <- datos[datos1 == 2,]

# Train

lm1 <- lm(formula = Y ~ . , data=train )
summary(lm1)

test$Y_Predict <- predict(lm1, newdata=test)
head(test[ , c('Y', 'Y_Predict')])
entrada <- data.frame(X1=3,
                      X2=3,
                      X3=3,
                      X4=3,
                      X5=3)
salida <- predict(lm1,newdata = entrada)
print(salida)
# Conexión con la aplicación
#SATISFACCION, SALUD_AUTOPERCIBIDA, SEGURIDAD_AUTOPERCIBIDA, 
#                                     NIVEL_DE_EDUCACION, COND_VIDA_DEL_HOGAR, TRABAJO_AUTOPERCIBIDO
save(file="App/data/modeloSatisfaccion.RData",
                              list=c("lm1"))
```

### Satisfacción en la Salud

Según (PONER BIBLIOGRAFÍA) se seleccionan las siguientes variables como posibles predictores de la satisfacción de la Salud de los abuelos:

* AFILIADO (p6090)
* PAGO_EPS (p8551)
* CALIDAD_PRESTADOR (p6181)
* ESTADO_SALUD (p6127)
* TIPO_PAGO (p6115)
* REGIMEN (P6100)
* ENFERMEDAD_CRONICA (P1930)

#### Análisis Descriptivo
```{r, echo = FALSE}
# Une las tablas
df_salud <- merge(x = comp_hogar, y = salud, by = "ID_Persona")
df_salud <- merge(x = datos_vivienda, y = df_salud, by = "DIRECTORIO")

# Selecciona solo las personas de 3era edad
df_salud <- subset(df_salud, df_salud$Clasificación == "3ra_edad")

# Selecciona las variables de interés
df_salud <- subset(df_salud, select = c("P1897", "P6181", "P6127", "P8520S1A1", "P6100", "P1930"))

# Cambia los nombres de las columnas
names(df_salud) = c("SATISFACCION", "CALIDAD_EPS", "ESTADO_SALUD", "ESTRATO", "REGIMEN", "ENFERMEDAD_CRONICA")
```

##### Matriz de Correlaciones
```{r, echo = FALSE}
M <- cor(df_salud)
ggcorrplot(M, hc.order = TRUE, type = "lower",
   lab = TRUE,tl.cex = 8, pch.col = "red",lab_size = 2)
```

#### Regresion con lm
```{r, echo=FALSE}
set.seed(27042022) # se fija por reproducibilidad


# Separación de los datos en entrenamiento y prueba
datos_salud <- sample(2, nrow(df_salud),
                   replace = T,
                   prob = c(0.75, 0.25))

train_salud <- df_salud[datos_salud == 1,]
test_salud <- df_salud[datos_salud == 2,]

# Train
head(train_salud)
lm_salud <- lm(formula = SATISFACCION ~ . , data=train_salud)
summary(lm_salud)

test_salud$Y_Predict <- predict(lm_salud, newdata=test_salud)
head(test_salud[ , c('SATISFACCION', 'Y_Predict')])

save(file="App/data/modeloSatisfaccionSalud.RData",
                              list=c("lm_salud"))

str(train_salud)
```

### Satisfacción sobre el Nivel de Seguridad
Según (PONER BIBLIOGRAFÍA) se seleccionan las siguientes variables como posibles predictores de la satisfacción de la seguridad de los abuelos:

* ESTADO_CIVIL (P5502)
* SEXO (P6020´)
* ESTRATO (P8520S1A1)
* NIVEL_DE_SEGURIDAD (P9010)
* CONDICIONES_DE_VIDA_HOGAR (P9030)
* ES_CAMPESINO (P2059)
* CAI P1913S5
* ROBO P9025S2
* OTRO_DELITO P9025S1
* LEE_ESCRIBE (P6160)

#### Análisis Descriptivo
```{r, echo = FALSE}
# Une las tablas

df_seguridad <- merge(x = comp_hogar, y = fuerza_trabajo, by = "ID_Persona")
df_seguridad <- merge(x = df_seguridad, y = educacion, by = "ID_Persona")
df_seguridad <- merge(x = df_seguridad, y = cond_hogar, by = "ID_Hogar")
df_seguridad <- merge(x = df_seguridad, y = datos_vivienda, by = "DIRECTORIO")

# Selecciona solo las personas de 3era edad
df_seguridad <- subset(df_seguridad, df_seguridad$Clasificación == "3ra_edad")

# Selecciona las variables de interés
df_seguridad <- subset(df_seguridad, select = c("P1898", "P5502", "P6020", "P8520S1A1",
                                                "P9010", "P9030", "P2059",
                                                "P1913S5", "P9025S2", "P9025S1", "P6160"))

# Cambia los nombres de las columnas
names(df_seguridad) = c("SATISFACCION", "ESTADO_CIVIL", "SEXO", "ESTRATO",
                        "NIVEL_DE_SEGURIDAD", "CONDICIONES_DE_VIDA_HOGAR",
                      "ES_CAMPESINO","CAI", "ROBO", "OTRO_DELITO", "LEE_ESCRIBE")

```

##### Matriz de Correlaciones Pearson

```{r, echo = FALSE}
M <- cor(df_seguridad)
ggcorrplot(M, hc.order = TRUE, type = "lower",
    lab = TRUE,tl.cex = 8, pch.col = "red",lab_size = 2)
```

##### Correlaciones Polychoric

Para tener mayor certeza sobre la relación entre variables, se hace uso del método Polychoric y se obtuvieron los siguientes resultados:
```{r, echo = FALSE}

corr1 <- polychor(df_seguridad$SATISFACCION, df_seguridad$ESTADO_CIVIL)
corr2 <- polychor(df_seguridad$SATISFACCION, df_seguridad$SEXO)
corr3 <- polychor(df_seguridad$SATISFACCION, df_seguridad$ESTRATO)
corr4 <- polychor(df_seguridad$SATISFACCION, df_seguridad$NIVEL_DE_SEGURIDAD)
corr5 <- polychor(df_seguridad$SATISFACCION, df_seguridad$CONDICIONES_DE_VIDA_HOGAR)
corr6 <- polychor(df_seguridad$SATISFACCION, df_seguridad$ES_CAMPESINO)
corr7 <- polychor(df_seguridad$SATISFACCION, df_seguridad$CAI)
corr8 <- polychor(df_seguridad$SATISFACCION, df_seguridad$ROBO)
corr9 <- polychor(df_seguridad$SATISFACCION, df_seguridad$OTRO_DELITO)
corr10 <- polychor(df_seguridad$SATISFACCION, df_seguridad$LEE_ESCRIBE)

cor_poly <- data.frame(ESTADO_CIVIL = c(corr1), SEXO = c(corr2), 
                       ESTRATO = c(corr3), NIVEL_DE_SEGURIDAD  = c(corr4), 
                       CONDICIONES_DE_VIDA_HOGAR  = c(corr5), ES_CAMPESINO = c(corr6),
                       CAI = c(corr7), ROBO = c(corr8), OTRO_DELITO = c(corr9),
                       LEE_ESCRIBE = c(corr10))
cor_poly
```

Por tal motivo, se decide eliminar las variables SEXO, ESTRATO, ES_CAMPESINO y CAI ya que no presentan un correlación significativa con la variable objetivo.

```{r, echo = FALSE}
df_seguridad = subset(df_seguridad, select = c(-SEXO, -ESTRATO, -ES_CAMPESINO, -CAI))
```

#### Regresion con lm
```{r, echo=FALSE}
set.seed(27042022) # se fija por reproducibilidad


# Separación de los datos en entrenamiento y prueba
datos_seguridad <- sample(2, nrow(df_seguridad),
                   replace = T,
                   prob = c(0.75, 0.25))

train_seguridad <- df_seguridad[datos_seguridad == 1,]
test_seguridad <- df_seguridad[datos_seguridad == 2,]

# Train
lm1 <- lm(formula = SATISFACCION ~ . , data=train_seguridad)
summary(lm1)

test_seguridad$Y_Predict <- predict(lm1, newdata=test_seguridad)
head(test_seguridad[ , c('SATISFACCION', 'Y_Predict')])
```

### Satisfacción en el Trabajo
Según (PONER BIBLIOGRAFÍA) se seleccionan las siguientes variables como posibles predictores de la satisfacción en el trabajo de los abuelos:

* SEXO (P6020´)
* CARGO (P6435)
* TIENE_CONTRATO (P6440)
* TIPO_CONTRATO (P6460)
* SALARIO (P8624)
* HORAS_LABORALES (P415)
* RECIBIO_PRIMAS (P8631)
* RECIBIO_PENSIONES (P8642)

#### Análisis Descriptivo

```{r, echo = FALSE}
# Une las tablas
df_trabajo <- merge(x = comp_hogar, y = fuerza_trabajo, by = "ID_Persona")
df_trabajo <- merge(x = df_trabajo, y = salud, by = "ID_Persona")
df_trabajo <- merge(x = df_trabajo, y = cond_hogar, by = "ID_Hogar")

# Selecciona solo las personas de 3era edad
df_trabajo <- subset(df_trabajo, df_trabajo$Clasificación == "3ra_edad")

# Selecciona las variables de interés
df_trabajo <- subset(df_trabajo, select = c("P1899", "P6020", "P6435", "P6440", 
                                        "P6460", "P8624", "P415", "P8631", "P8642"))
# Cambia los nombres de las columnas
names(df_trabajo) = c("SATISFACCION", "SEXO", "CARGO", "TIENE_CONTRATO", "TIPO_CONTRATO",
                      "SALARIO", "HORAS_LABORALES", "RECIBIO_PRIMAS", "RECIBIO_PENSIONES")
```

#### Datos Faltantes

Para este dataframe se tiene la siguiente cantidad de abuelos:
```{r, echo=FALSE}
count(df_trabajo, name = "Cantidad de Abuelos")
```
Sin embargo, si se observa la cantidad de abuelos que respondieron a las preguntas seleccionadas:
```{r, echo=FALSE}
gg_miss_upset(subset(df_trabajo, select = c(-RECIBIO_PRIMAS, -RECIBIO_PENSIONES)))
```

se puede determinar que la mayoría de estos no respondieron a las preguntas que se les hicieron sobre el trabajo. Este mismo procedimiento se repitió con variables diferentes, pero no se obtuvieron resultados distintos a los presentados. Por tal motivo, se decide no realizar un modelo de predicción para la satisfacción del trabajo en los abuelos. En primera instancia se pensó que este comportamiento se debía a que la mayoría de los abuelos estaban pensionados, pero si se observan los abuelos pensionados:

```{r, echo=FALSE}
 barplot(table(df_trabajo$RECIBIO_PENSIONES), main = "¿Recibe pensión?")
```

la gran mayoría de estos respondieron que no recibían algún tipo de pensión (2). Por tanto, se puede inferir que la mayoría de los abuelos no trabajan y tampoco reciben pensión, es decir, viven dependientes de sus familiares.

## Modelos Predictivos en Niños
```{r}
# los datos:
ninos <- read.csv2("Datos/datos_ninos.csv", header=TRUE, dec=".", encoding="UTF-8")
```
### Correlaciones
```{r}
corr_ninos <- ninos %>% select(SATISFACCION, ESTADO_SALUD, ACTIVIDADES, ETNIA, 
                               CONDIC_VIDA_HOGAR, INCRESOS_AUTOPERCIBIDOS_HOGAR,
                               PERCAPITA, CANT_PERSONAS_HOGAR, ESCUELA_OFICIAL,
                               VALOR_BECA, ORIGEN_SUBSIDIO_EDUC, UBICACION_ESCUELA, 
                               TRANSPORTE_ESCUELA, TIEMPO_TRANSPORTE_ESC, 
                               EDUCACION_PADRES ,ACTIVIDAD_ULT_SEMANA, 
                               LUGAR_TRABAJO, ENFERMEDAD_CRONICA, INCAP)

M = cor(corr_ninos, use = "pairwise.complete.obs")

M[is.na(M)]=0

ggcorrplot(M, hc.order = TRUE, type = "lower", lab = TRUE,tl.cex = 6, 
            pch.col = "red", lab_size = 2)

```

Los datos para niños:
```{r}
df_ninos <- ninos %>% select(INCAP, SATISFACCION, 
                             PERCAPITA, INCRESOS_AUTOPERCIBIDOS_HOGAR, 
                             UBICACION_ESCUELA, EDUCACION_PADRES,
                             CONDIC_VIDA_HOGAR, TIEMPO_TRANSPORTE_ESC, HORAS_TRABAJO)

df_ninos['ETNIA'] = as.factor(ninos[,'ETNIA'])

df_ninos['VIVE_CON_PADRE'] = factor(ninos[,'VIVE_CON_PADRE'], labels = c(TRUE, 
                                                                         FALSE, 
                                                                         'Muerto'))

df_ninos['VIVE_CON_MADRE'] = factor(ninos[,'VIVE_CON_MADRE'], labels = c(TRUE, 
                                                                         FALSE, 
                                                                         'Muerto'))

df_ninos['ESCUELA_OFICIAL'] = factor(ninos[,'ESCUELA_OFICIAL'], labels = c('Oficial', 
                                                              'conSubstito', 
                                                              'SinSubstito'))

df_ninos['TRANSPORTE_ESCUELA'] = addNA(factor(ninos[,'TRANSPORTE_ESCUELA'], 
                                        labels = c('Carro', 'escolar', 'público',
                                                   'pie', 'Bicicleta', 'Caballo',
                                                   'canoa', 'Otro')))

df_ninos['ENFERMEDAD_CRONICA'] =  addNA(factor(ninos[,'ENFERMEDAD_CRONICA'], 
                                               labels = c(TRUE, FALSE)))

df_ninos['ACTIVIDAD_ULT_SEMANA'] = addNA(factor(ninos[,'ACTIVIDAD_ULT_SEMANA'], 
                                          labels = c( 'Trabajando', 'Buscando',
                                                      'Estudiando', 'Oficios_hogar', 
                                                      'Incapacitado trabajar', 'Otra')))

df_ninos['LUGAR_TRABAJO'] = addNA(factor(ninos[,'LUGAR_TRABAJO'], 
                                         labels = c('no trabajo', 'la vivienda',
                                                    'otra vivienda', 'Puerta', 
                                                    'calle', 'oficina', 'campo',
                                                    'obra')))

head(df_ninos)
```
### Resultados del entrenamiento

* Separación de los datos en entrenamiento y prueba
```{r}
datos1 <- sample(2, nrow(df_ninos),
                   replace = TRUE,
                    prob = c(0.75, 0.25))

train <- df_ninos[datos1 == 1,]
test <- df_ninos[datos1 == 2,]
```

* Modelo de árbol de decisión
```{r}
modelo <- ctree(formula = SATISFACCION ~ ., data=train, 
                controls = ctree_control(mincriterion = 0.7))
```

```{r}
png(file = "decision_tree.png", width = 6000, height = 3000, )
#plot(modelo)
dev.off()
modelo
```

```{r}
test_pred <- predict(modelo, newdata = test)
colnames(test_pred) <- c('pred_Satisfaccion')
test_pred <- cbind(test_pred, test['SATISFACCION'])

cat_test_pred = lapply(test_pred/5.6, as.integer)
table(cat_test_pred)
```

```{r}
train_pred <- predict(modelo, newdata = train)
colnames(train_pred) <- c('pred_Satisfaccion')
train_pred <- cbind(train_pred, train['SATISFACCION'])

cat_train_pred = lapply(train_pred/5.6, as.integer)
table(cat_train_pred)
```
### Calificación por "Feature Selection"
En lo consiguiente calculamos unas métricas para mejorar el arbol:
Sacamos paso a paso una del los variables y miramos que impacto tiene cada.

**Resultados:**
* CANT_PERSONAS_HOGAR y EDAD tienen un impacto negativo en los datos de la prueba y positivo en entrenamiento.
  ** Significa que estos variables pruducen "overfitting".
* PERCAPITA, INCRESOS_AUTOPERCIBIDOS_HOGAR, UBICACION_ESCUELA, EDUCACION_PADRES, CONDIC_VIDA_HOGAR, ETNIA, ESCUELA_OFICIAL, TRANSPORTE_ESCUELA, EDUCACION_PADRES, ACTIVIDAD_ULT_SEMANA, ENFERMEDAD_CRONICA tienen un impacto estrictamente positivo.
* INCAP, LUGAR_TRABAJO, TIEMPO_TRANSPORTE_ESC tienen a veses un impacto positivo y en otros casos producen overfitting
 ** Decidimos usar estos variables porque el impacto positivo es más grande que el negativo. 
* HORAS_TRABAJO y VALOR_BECA no van a usar, sin embargo, tienen una impacto positivo.
 ** Sacamos VALOR_BECA porque la correlación que hemos visto antes depende mucho de un valor atípico.

#### Cálculo de métricas 
```{r}
MSE_train <- mean((train_pred$SATISFACCION - train_pred$pred_Satisfaccion)^2)

MS_train <- mean(train_pred$SATISFACCION)^2

MSE_cat_train <- mean((cat_train_pred$SATISFACCION - cat_train_pred$pred_Satisfaccion)^2)

MS_cat_train <- mean(cat_train_pred$SATISFACCION)^2

MAE_train <- mean(abs(train_pred$SATISFACCION - train_pred$pred_Satisfaccion))

MAE_cat_train <- mean(abs(cat_train_pred$SATISFACCION - cat_train_pred$pred_Satisfaccion))

RMSE_cat_train <- sqrt(mean((cat_train_pred$SATISFACCION - cat_train_pred$pred_Satisfaccion)^2))
```
Entrenamiento
- MSE: {MSE_train}
- MS: {MS_trains}
- MAE: {MAE_train}
Para las 10 categorías
- MSE: {MSE_cat_train}
- MS: {MS_cat_train}
- MAE: {MAE_cat_train}
- RMSE: {RMSE_cat_train}


```{r}
MSE_test <- mean((test_pred$SATISFACCION - test_pred$pred_Satisfaccion)^2)

MSE_cat_test <- mean((cat_test_pred$SATISFACCION - cat_test_pred$pred_Satisfaccion)^2)

MAE_test <- mean(abs(test_pred$SATISFACCION - test_pred$pred_Satisfaccion))

MAE_cat_test <- mean(abs(cat_test_pred$SATISFACCION - cat_test_pred$pred_Satisfaccion))

RMSE_test <- sqrt(mean((cat_test_pred$SATISFACCION - cat_test_pred$pred_Satisfaccion)^2))
```
Prueba
- MSE: {MSE_test}
- MAE: {MAE_test}
Para las 10 categorías
- MSE: {MSE_cat_test}
- MAE: {MAE_cat_test}
- RMSE: {RMSE_test}


#### Matriz de confusión de los datos
Entrenamiento
```{r}
# to factor
cat_train_pred$SATISFACCION = factor(cat_train_pred$SATISFACCION)
cat_train_pred$pred_Satisfaccion = factor(cat_train_pred$pred_Satisfaccion)

#reorder
cat_train_pred$pred_Satisfaccion = factor(cat_train_pred$pred_Satisfaccion, 
                                          levels=c(0,1,2,3,4,5,6,7,8,9))

#create confusion matrix
confusionMatrix(table(cat_train_pred))

```
Prueba
```{r}
# to factor
cat_test_pred$SATISFACCION = factor(cat_test_pred$SATISFACCION)
cat_test_pred$pred_Satisfaccion = factor(cat_test_pred$pred_Satisfaccion)

#reorder
cat_test_pred$SATISFACCION = factor(cat_test_pred$SATISFACCION, 
                                    levels=c(0,1,2,3,4,5,6,7,8,9))

cat_test_pred$pred_Satisfaccion = factor(cat_test_pred$pred_Satisfaccion, 
                                         levels=c(0,1,2,3,4,5,6,7,8,9))

#create confusion matrix
confusionMatrix(table(cat_test_pred))
levels(cat_test_pred$SATISFACCION)
```


# Conclusiones

# Recomendaciones

\begin{thebibliography}{X}
\bibitem{b1}
Ramírez Pérez, Mauricio; Lee Maturana, Sau-Lyn (2012). Factores asociados a la satisfacción vital en adultos mayores de 60 años. Polis (Santiago), 11(33), 407–428. doi:10.4067/s0718-65682012000300020
\bibitem{b2}
Kutubaeva RZh (2019) Analysis of life satisfaction of the elderly population on the example of Sweden, Austria and Germany. Population and Economics 3(3): 102-116. https://doi.org/10.3897/popecon.3.e47192
\bibitem{b3}
Palmore, E., Luikart, C. (1972). Health and Social Factors Related to Life Satisfaction. Journal of Health and Social Behavior, 13(1), 68–80. doi: 10.2307/2136974
\bibitem{b4}
Naidu, Aditi (2009). Factors affecting patient satisfaction and healthcare quality. International Journal of Health Care Quality Assurance, 22(4), 366–381. doi:10.1108/09526860910964834 
\bibitem{b5}
ROBLES-GARCIA, Monica et al. Variables relacionadas con la satisfaccion laboral: un estudio transversal a partir del modelo EFQM. Gac Sanit [online]. 2005, vol.19, n.2, pp.127-134. ISSN 0213-9111
\bibitem{b6}
Booth, Jaime; Ayers, Stephanie L.; and Marsiglia, Flavio F. (2012) "Perceived Neighborhood Safety and Psychological Distress: Exploring Protective Factors," The Journal of Sociology \& Social Welfare: Vol. 39 : Iss. 4 , Article 8. Available at: https://scholarworks.wmich.edu/jssw/vol39/iss4/
\bibitem{b7}
https://ourworldindata.org/happiness-and-life-satisfaction
\end{thebibliography}

